USE TestDb;
BEGIN TRANSACTION;
GO
CREATE OR ALTER TRIGGER [STOREHOUSE].[PRODUCT_INSERT] ON [STOREHOUSE].[PRODUCT]
   AFTER INSERT
AS 
BEGIN
	SET ANSI_NULLS ON;
	SET QUOTED_IDENTIFIER ON;
	IF (ROWCOUNT_BIG() = 0) RETURN;
	SET NOCOUNT ON;
	WITH 
	INSERTED_DATA AS
	(
		SELECT
			ID,
			NAME,
			DESCRIPTION
		FROM inserted
	),
	JSON_DATA([DATA]) AS
	(
		SELECT 
		(
		SELECT
			'INSERT' AS "ACTION",
			'PRODUCT' AS "TABLE",
			(SELECT * FROM INSERTED_DATA FOR JSON PATH) AS "DATA"
		FOR JSON PATH
		) AS [DATA]
	)
	INSERT INTO [STOREHOUSE].[EVENTLOG]
	SELECT
		NEWID(),
		sysdatetimeoffset() as EVENTDATE,
		(SELECT JSON_DATA.[DATA] FROM JSON_DATA) AS DESCRIPTION;
END
GO
CREATE OR ALTER TRIGGER [STOREHOUSE].[PRODUCT_DELETE] ON [STOREHOUSE].[PRODUCT]
   AFTER DELETE
AS 
BEGIN
	SET ANSI_NULLS ON;
	SET QUOTED_IDENTIFIER ON;
	IF (ROWCOUNT_BIG() = 0) RETURN;
	SET NOCOUNT ON;
	WITH 
	DELETE_DATA AS
	(
		SELECT
			ID,
			NAME,
			DESCRIPTION
		FROM deleted
	),
	JSON_DATA([DATA]) AS
	(
		SELECT
		(SELECT
			'DELETE' AS "ACTION",
			'PRODUCT' AS "TABLE",
			(SELECT * FROM DELETE_DATA FOR JSON PATH) AS "DATA"
		FOR JSON PATH) AS [DATA]
	)
	INSERT INTO [STOREHOUSE].[EVENTLOG]
	SELECT
		NEWID(),
		sysdatetimeoffset() as EVENTDATE,
		(SELECT JSON_DATA.[DATA] FROM JSON_DATA) AS DESCRIPTION;
END
GO
CREATE OR ALTER TRIGGER [STOREHOUSE].[PRODUCT_UPDATE] ON [STOREHOUSE].[PRODUCT]
   AFTER UPDATE
AS 
BEGIN
	SET ANSI_NULLS ON;
	SET QUOTED_IDENTIFIER ON;
	IF (ROWCOUNT_BIG() = 0) RETURN;
	SET NOCOUNT ON;
	WITH 
	UPDATE_DATA AS
	(
		SELECT
			ID,
			NAME,
			DESCRIPTION
		FROM inserted
	),
	JSON_DATA([DATA]) AS
	(
		SELECT(
		SELECT
			'UPDATE' AS "ACTION",
			'PRODUCT' AS "TABLE",
			(SELECT * FROM UPDATE_DATA FOR JSON PATH) AS "DATA"
		FOR JSON PATH) AS [DATA]
	)
	INSERT INTO [STOREHOUSE].[EVENTLOG]
	SELECT
		NEWID(),
		sysdatetimeoffset() as EVENTDATE,
		(SELECT JSON_DATA.[DATA] FROM JSON_DATA) AS DESCRIPTION;
END
GO
ENABLE TRIGGER ALL ON [STOREHOUSE].[PRODUCT];
COMMIT TRANSACTION;
